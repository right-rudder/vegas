---
class FAQsClass {
  question: string;
  answer: string;

  constructor() {
    this.question = "";
    this.answer = "";
  }
}

const { faqs = FAQsClass, showTitle = true } = Astro.props;
---

<script>
  class Accordion {
    el;
    summary;
    content;
    animation: Animation;
    isClosing;
    isExpanding;

    constructor(el: any) {
      // Store the <details> element
      this.el = el;
      // Store the <summary> element
      this.summary = el.querySelector("summary");
      // Store the <div class="content"> element
      this.content = el.querySelector("div");

      // Store the animation object (so we can cancel it if needed)
      this.animation = new Animation();
      // Store if the element is closing
      this.isClosing = false;
      // Store if the element is expanding
      this.isExpanding = false;
      // Detect user clicks on the summary element
      this.summary?.addEventListener("click", (e: any) => this.onClick(e));

      this.el.accordionObj = this;
    }

    onClick(e: MouseEvent) {
      // Stop default behaviour from the browser
      e.preventDefault();
      // Add an overflow on the <details> to avoid content overflowing
      this.el.style.overflow = "hidden";
      // Check if the element is being closed or is already closed
      if (this.isClosing || !this.el.open) {
        this.open();
        // Check if the element is being openned or is already open
      } else if (this.isExpanding || this.el.open) {
        this.shrink();
      }
    }

    shrink() {
      // Set the element as "being closed"
      this.isClosing = true;

      // Store the current height of the element
      const startHeight = `${this.el.offsetHeight}px`;
      // Calculate the height of the summary
      const endHeight = `${this.summary?.offsetHeight}px`;

      // If there is already an animation running
      if (this.animation) {
        // Cancel the current animation
        this.animation.cancel();
      }

      // Start a WAAPI animation
      this.animation = this.el.animate(
        {
          // Set the keyframes from the startHeight to endHeight
          height: [startHeight, endHeight],
        },
        {
          duration: 400,
          easing: "ease-out",
        }
      );

      // When the animation is complete, call onAnimationFinish()
      this.animation.onfinish = () => this.onAnimationFinish(false);
      // If the animation is cancelled, isClosing variable is set to false
      this.animation.oncancel = () => (this.isClosing = false);
    }

    open() {
      // Apply a fixed height on the element
      this.el.style.height = `${this.el.offsetHeight}px`;
      // Force the [open] attribute on the details element
      this.el.open = true;
      // Wait for the next frame to call the expand function
      window.requestAnimationFrame(() => this.expand());
    }

    expand() {
      // // Set the element as "being expanding"
      // this.isExpanding = true;
      // // Get the current fixed height of the element
      // const startHeight = `${this.el.offsetHeight}px`;
      // // Calculate the open height of the element (summary height + content height)
      // const summaryHeight = this.summary?.offsetHeight || 0;
      // const contentHeight = this.content?.offsetHeight || 0;

      // const endHeight = `${summaryHeight + contentHeight}px`;

      // // If there is already an animation running
      // if (this.animation) {
      //   // Cancel the current animation
      //   this.animation.cancel();
      // }

      // // Start a WAAPI animation
      // this.animation = this.el.animate(
      //   {
      //     // Set the keyframes from the startHeight to endHeight
      //     height: [startHeight, endHeight],
      //   },
      //   {
      //     duration: 400,
      //     easing: "ease-out",
      //   }
      // );
      // // When the animation is complete, call onAnimationFinish()
      // this.animation.onfinish = () => this.onAnimationFinish(true);
      // // If the animation is cancelled, isExpanding variable is set to false
      // this.animation.oncancel = () => (this.isExpanding = false);

      // Apply fixed height before opening
      this.el.style.height = `${this.el.offsetHeight}px`;

      // Temporarily keep it closed so the browser doesnâ€™t jump
      this.el.open = true;
      this.content.style.display = "block"; // ensure content is measurable

      const startHeight = `${this.el.offsetHeight}px`;

      // Measure expanded height (while content is visible)
      const summaryHeight = this.summary?.offsetHeight || 0;
      const contentHeight = this.content?.offsetHeight || 0;
      const endHeight = `${summaryHeight + contentHeight}px`;

      // Animate expansion
      if (this.animation) this.animation.cancel();

      this.animation = this.el.animate({ height: [startHeight, endHeight] }, { duration: 400, easing: "ease-out" });

      this.isExpanding = true;

      this.animation.onfinish = () => this.onAnimationFinish(true);
      this.animation.oncancel = () => (this.isExpanding = false);
    }

    onAnimationFinish(open: boolean) {
      // // Set the open attribute based on the parameter
      // this.el.open = open;
      // // Clear the stored animation
      // this.animation = new Animation();
      // // Reset isClosing & isExpanding
      // this.isClosing = false;
      // this.isExpanding = false;
      // // Remove the overflow hidden and the fixed height
      // this.el.style.height = this.el.style.overflow = "";

      this.el.open = open;
      this.animation = new Animation();
      this.isClosing = false;
      this.isExpanding = false;
      this.el.style.height = "";
      this.el.style.overflow = "";
    }
  }

  document.querySelectorAll("details").forEach((el) => {
    new Accordion(el);
  });
</script>

<style>
  details > summary {
    height: 100%;
    position: relative;
  }

  details > summary::before {
    content: "";
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 2rem; /* w-8 */
    clip-path: polygon(0% 0%, 75% 0%, 100% 50%, 75% 100%, 0% 100%);
    background: oklch(0.75019 0.21579 135.347); /* bg-primary-500 */
    pointer-events: none;
  }

  details[open] > summary {
    height: auto;
  }

  details[open] > summary:focus {
    outline-style: none !important;
  }

  details > summary > span {
    position: relative;
    display: inline-block;
    color: white;
    overflow: hidden;
    background: linear-gradient(
      to right,
      oklch(0.75019 0.21579 135.347),
      oklch(0.75019 0.21579 135.347) 50%,
      white 50%
    );

    background-clip: text;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-size: 200% 100%;
    background-position: 100%;
    transition: background-position 0.3s ease;
  }

  details[open] > summary > span {
    background-position: 0 100%;
  }

  details summary::-webkit-details-marker {
    display: none;
  }
</style>

<div class="bg-accent-100">
  <div class="mx-auto text-center flex flex-col items-center justify-center max-w-7xl p-8 px-4 lg:px-0">
    <div class="w-full max-w-7xl mx-auto flex flex-col items-center justify-center">
      {
        showTitle && (
          <h2 class="my-3 text-5xl font-bold text-center max-w-5xl mx-auto uppercase border-b-4 gradient-border-image pb-2">
            Frequently Asked Questions
          </h2>
        )
      }

      <dl class="flex flex-col gap-4 mt-6 w-full justify-stretch items-stretch">
        {
          faqs.map((faq: FAQsClass) => (
            <details class="w-full relative">
              <summary class="p-1 py-2 pl-12 flex bg-accent-900 text-white font-semibold cursor-pointer rounded-sm overflow-hidden text-left relative list-none focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 focus:ring-offset-primary-900">
                <span>{faq.question}</span>
              </summary>
              <div class="w-full text-left mt-0.5" set:html={faq.answer} />
            </details>
          ))
        }
      </dl>
    </div>
    <small class="mt-2"
      >Got any more questions? <a
        href="/contact"
        class="text-primary-500 hover:text-accent-950 font-semibold transition-all duration-300">Contact Us</a
      >
    </small>
  </div>
</div>
